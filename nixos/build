#! /usr/bin/env bash

set +x

prep_home() {
    
    if ! command -v home-manager &> /dev/null
    then
	    echo "HomeManager not found, creating ..."
        # home manager files
        nix-channel --add https://github.com/nix-community/home-manager/archive/release-23.11.tar.gz home-manager
        nix-channel --update
        nix-shell '<home-manager>' -A install
    fi

    echo "Cleaning..."
    rm -r $HOME/.config/home-manager

	echo "Copying files ..."
	mkdir -p $HOME/.config/home-manager
	mkdir -p $HOME/.config/home-manager/home

	cp ./home.nix $HOME/.config/home-manager/
	cp -r ./home/* $HOME/.config/home-manager/home/
    cp ./system/vimrc $HOME/.config/home-manager/home/
}

bsystem() {
    echo "buiding system, arguments: $@"
	#sudo nix-channel --add https://nixos.org/channels/nixos-unstable nixos
    sudo mkdir -p /etc/nixos/system
	sudo cp configuration.nix /etc/nixos/
    sudo cp -r ./system/. /etc/nixos/system
    #WSL patch
    sudo mount -o remount,rw /tmp/.X11-unix
	sudo nixos-rebuild switch $@
}

bhome() {
	prep_home
    echo "buiding home, arguments: $@"
	home-manager switch $@
}

all() {
    echo "buiding system and home, arguments: $@"
	bsystem $@ && bhome $@
}

case $1 in 
	"home")
		bhome ${@:2};;
	"system")
		bsystem ${@:2};;
	*)
        all ${@:2};;
esac
